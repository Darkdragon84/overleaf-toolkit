version: '3.3'
services:
    sharelatex:
      restart: unless-stopped
      stop_grace_period: 60s
      image: sharelatex/sharelatex:4.2.3
      container_name: sharelatex
      env_file:
        - ./.env
      volumes:
          - "/srv/overleaf/data:/var/lib/sharelatex"
      environment:
        SHARELATEX_REDIS_HOST: "${REDIS_HOST}"
        V1_HISTORY_URL: "http://sharelatex:3100/api"
      labels:
        # activate traefik
        - traefik.enable=true
        - traefik.docker.network=traefik-public
        - traefik.constraint-label=traefik-public
        - traefik.http.middlewares.sharelatex-https-redirect.redirectscheme.scheme=https
        # do we need to activate this middleware?
        - traefik.http.middlewares.sharelatex-header.headers.referrerPolicy=no-referrer
        - traefik.http.middlewares.sharelatex-header.headers.stsSeconds=15552000
        - traefik.http.middlewares.sharelatex-header.headers.forceSTSHeader=true
        - traefik.http.middlewares.sharelatex-header.headers.stsPreload=true
        - traefik.http.middlewares.sharelatex-header.headers.stsIncludeSubdomains=true
        - traefik.http.middlewares.sharelatex-header.headers.browserXssFilter=true
        - traefik.http.middlewares.sharelatex-header.headers.customRequestHeaders.X-Forwarded-Proto=https

        - traefik.http.routers.sharelatex.entrypoints=http
        - traefik.http.routers.sharelatex.rule=Host(`${OVERLEAF_DOMAIN}`)
        - traefik.http.routers.sharelatex.middlewares=sharelatex-https-redirect
        
        - traefik.http.routers.sharelatex-https.rule=Host(`${OVERLEAF_DOMAIN}`)
        - traefik.http.routers.sharelatex-https.entrypoints=https
        - traefik.http.routers.sharelatex-https.tls=true
        - traefik.http.routers.sharelatex-https.tls.certresolver=le
        - traefik.http.routers.sharelatex-https.service=sharelatex
        - traefik.http.services.sharelatex.loadbalancer.server.port=80
      depends_on:
        - sharelatex-mongo
        - sharelatex-redis
      networks:
        - overleaf
        - traefik-public

    sharelatex-mongo:
      image: mongo:5.0
      container_name: sharelatex-mongo
      restart: unless-stopped
      command: --replSet overleaf
      env_file:
        - .env
      volumes:
        - mongo:/data/db
      expose:
        - 27017
      healthcheck:
        test: echo 'db.stats().ok' | mongo localhost:27017/test --quiet
        interval: 10s
        timeout: 10s
        retries: 5
      networks:
        - overleaf

    sharelatex-redis:
      image: redis:6.2
      container_name: sharelatex-redis
      restart: unless-stopped
      env_file:
        - ./.env
      volumes:
        - redis:/data
      networks:
        - overleaf

volumes:
  mongo:
  redis:

networks:
  overleaf:
    driver: bridge
  traefik-public:
    external: true
